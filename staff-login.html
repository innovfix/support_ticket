<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Desk | Staff Login</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="login-container">
        <div class="app-icon">
            <i class="fas fa-users"></i>
        </div>
        <h1>Staff Login</h1>
        <p class="login-subtitle">Access your assigned queries</p>
        
        <form id="staffLoginForm">
            <div class="input-group">
                <input type="email" id="staffUserId" placeholder="Email" required>
            </div>
            <div class="input-group">
                <input type="password" id="staffPassword" placeholder="Password" required>
            </div>
            <button type="submit" class="login-btn staff-login-btn">
                <span id="btnText">Login</span>
                <span id="btnLoading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Logging in...
                </span>
            </button>
        </form>

        <div class="back-to-main" style="margin-top: 16px;">
            <a href="staff-register.html"><i class="fas fa-user-plus"></i> New staff? Register here</a>
        </div>
        
        <div class="back-to-main">
            <a href="index.html">
                <i class="fas fa-arrow-left"></i> Back to Main
            </a>
        </div>
    </div>
    
    <script src="script.js?v=1.3"></script>
    <script>
        // Prefill email from query string
        const params = new URLSearchParams(window.location.search);
        const email = params.get('email');
        if (email) {
            document.addEventListener('DOMContentLoaded', () => {
                const input = document.getElementById('staffUserId');
                if (input) { 
                    input.value = email; 
                }
            });
        }

        // Staff Login Form Handler
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('staffLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('staffUserId').value.trim();
                    const password = document.getElementById('staffPassword').value;
                    
                    if (!email || !password) {
                        alert('Please fill in all fields');
                        return;
                    }

                    // Show loading state
                    const btnText = document.getElementById('btnText');
                    const btnLoading = document.getElementById('btnLoading');
                    btnText.style.display = 'none';
                    btnLoading.style.display = 'inline-block';

                    try {
                        // Determine correct API base URL
                        const origin = window.location.origin || '';
                        const base = (origin.includes('127.0.0.1:5500') || origin.includes('localhost:5500')) 
                            ? 'http://localhost/hima-support/api/' 
                            : 'api/';
                        
                        console.log('API Base URL:', base);
                        
                        const response = await fetch(base + 'staff-login.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email, password })
                        });

                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Login failed');
                        }

                        const data = await response.json();
                        console.log('Login response:', data);

                        if (data.ok) {
                            // Store login state
                            sessionStorage.setItem('staffLoggedIn', 'true');
                            sessionStorage.setItem('staffEmail', email);
                            sessionStorage.setItem('staffName', data.name || email);
                            
                            // Redirect to staff dashboard
                            window.location.href = 'staff-dashboard.html';
                        } else {
                            throw new Error(data.error || 'Login failed');
                        }

                    } catch (error) {
                        console.error('Login error:', error);
                        alert(error.message || 'Login failed. Please check your credentials.');
                    } finally {
                        // Hide loading state
                        btnText.style.display = 'inline';
                        btnLoading.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>
