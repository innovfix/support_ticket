<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports & Analytics - Query Desk</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-header-bar">
        <div class="header-left">
            <div class="app-icon-small">
                <i class="fas fa-comments"></i>
            </div>
            <span class="app-name">Query Desk</span>
        </div>
        <div class="header-right">
            <a href="dashboard.html" class="action-btn">‚Üê Back to Manager Dashboard</a>
            <button onclick="logout()" class="action-btn logout-btn">Logout</button>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-chart-bar"></i> Reports & Analytics</h1>
            <p>Comprehensive insights into ticket performance and system metrics</p>
        </div>
        
        <div class="summary-cards">
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="totalTickets">0</div>
                    <div class="summary-label">Total Tickets</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="openTickets">0</div>
                    <div class="summary-label">Open Tickets</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-spinner"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="inProgressTickets">0</div>
                    <div class="summary-label">In Progress</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="resolvedTickets">0</div>
                    <div class="summary-label">Resolved</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="closedTickets">0</div>
                    <div class="summary-label">Closed</div>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-number" id="totalStaff">0</div>
                    <div class="summary-label">Total Staff</div>
                </div>
            </div>
        </div>

        <div class="charts-section">
            <div class="chart-container">
                <h3>Ticket Status Distribution</h3>
                <div class="chart" id="statusChart">
                    <canvas id="statusChartCanvas"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Priority Distribution</h3>
                <div class="chart" id="priorityChart">
                    <canvas id="priorityChartCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="reports-section">
            <h3>Detailed Reports</h3>
            <div class="report-controls">
                <select id="reportType" onchange="generateReport()">
                    <option value="">Select Report Type</option>
                    <option value="status">Status Report</option>
                    <option value="priority">Priority Report</option>
                    <option value="staff">Staff Performance</option>
                    <option value="timeline">Timeline Analysis</option>
                </select>
            </div>
            
            <div class="report-content">
                <div id="reportTable" class="report-table">
                    <!-- Report content will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.3"></script>
    <script>
        // Check if user is logged in as manager
        if (!sessionStorage.getItem('managerLoggedIn')) {
            window.location.href = 'manager-login.html';
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
        });

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load tickets data
                const origin = window.location.origin || '';
        const base = (origin.includes('127.0.0.1:5500') || origin.includes('localhost:5500')) 
            ? 'http://localhost/hima-support/api/' 
            : 'api/';
        const ticketsResponse = await fetch(base + 'tickets-list.php');
                if (ticketsResponse.ok) {
                    const tickets = await ticketsResponse.json();
                    updateSummaryCards(tickets);
                    generateCharts(tickets);
                }

                // Load staff data
                const staffResponse = await fetch(base + 'staff-list.php');
                if (staffResponse.ok) {
                    const staff = await staffResponse.json();
                    document.getElementById('totalStaff').textContent = staff.length;
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Update summary cards
        function updateSummaryCards(tickets) {
            const total = tickets.length;
            const open = tickets.filter(t => t.status === 'Pending').length;
            const inProgress = tickets.filter(t => t.status === 'In Progress').length;
            const resolved = tickets.filter(t => t.status === 'Resolved').length;
            const closed = tickets.filter(t => t.status === 'Closed').length;

            document.getElementById('totalTickets').textContent = total;
            document.getElementById('openTickets').textContent = open;
            document.getElementById('inProgressTickets').textContent = inProgress;
            document.getElementById('resolvedTickets').textContent = resolved;
            document.getElementById('closedTickets').textContent = closed;
        }

        // Generate charts
        function generateCharts(tickets) {
            generateStatusChart(tickets);
            generatePriorityChart(tickets);
        }

        // Generate status chart
        function generateStatusChart(tickets) {
            const statusCounts = {
                'Pending': tickets.filter(t => t.status === 'Pending').length,
                'In Progress': tickets.filter(t => t.status === 'In Progress').length,
                'Resolved': tickets.filter(t => t.status === 'Resolved').length,
                'Closed': tickets.filter(t => t.status === 'Closed').length
            };

            const ctx = document.getElementById('statusChartCanvas');
            if (ctx) {
                // Simple chart representation
                const chartContainer = document.getElementById('statusChart');
                chartContainer.innerHTML = `
                    <div class="chart-bars">
                        ${Object.entries(statusCounts).map(([status, count]) => `
                            <div class="chart-bar">
                                <div class="bar-label">${status}</div>
                                <div class="bar" style="height: ${count * 20}px; background: ${getStatusColor(status)};"></div>
                                <div class="bar-value">${count}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // Generate priority chart
        function generatePriorityChart(tickets) {
            const priorityCounts = {
                'High': tickets.filter(t => t.priority === 'High').length,
                'Medium': tickets.filter(t => t.priority === 'Medium').length,
                'Low': tickets.filter(t => t.priority === 'Low').length
            };

            const chartContainer = document.getElementById('priorityChart');
            chartContainer.innerHTML = `
                <div class="chart-bars">
                    ${Object.entries(priorityCounts).map(([priority, count]) => `
                        <div class="chart-bar">
                            <div class="bar-label">${priority}</div>
                            <div class="bar" style="height: ${count * 20}px; background: ${getPriorityColor(priority)};"></div>
                            <div class="bar-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'Pending': '#f59e0b',
                'In Progress': '#3b82f6',
                'Resolved': '#10b981',
                'Closed': '#6b7280'
            };
            return colors[status] || '#6b7280';
        }

        // Get priority color
        function getPriorityColor(priority) {
            const colors = {
                'High': '#ef4444',
                'Medium': '#f59e0b',
                'Low': '#10b981'
            };
            return colors[priority] || '#6b7280';
        }

        // Generate reports
        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            if (!reportType) return;

            try {
                const response = await fetch(base + 'tickets-list.php');
                if (response.ok) {
                    const tickets = await response.json();
                    displayReport(reportType, tickets);
                }
            } catch (error) {
                console.error('Error generating report:', error);
            }
        }

        // Display report
        function displayReport(reportType, tickets) {
            const reportTable = document.getElementById('reportTable');
            let reportContent = '';

            switch (reportType) {
                case 'status':
                    reportContent = generateStatusReport(tickets);
                    break;
                case 'priority':
                    reportContent = generatePriorityReport(tickets);
                    break;
                case 'staff':
                    reportContent = generateStaffReport(tickets);
                    break;
                case 'timeline':
                    reportContent = generateTimelineReport(tickets);
                    break;
            }

            reportTable.innerHTML = reportContent;
        }

        // Generate status report
        function generateStatusReport(tickets) {
            const statusCounts = {};
            tickets.forEach(ticket => {
                statusCounts[ticket.status] = (statusCounts[ticket.status] || 0) + 1;
            });

            return `
                <h4>Ticket Status Report</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(statusCounts).map(([status, count]) => `
                            <tr>
                                <td>${status}</td>
                                <td>${count}</td>
                                <td>${((count / tickets.length) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Generate priority report
        function generatePriorityReport(tickets) {
            const priorityCounts = {};
            tickets.forEach(ticket => {
                priorityCounts[ticket.priority] = (priorityCounts[ticket.priority] || 0) + 1;
            });

            return `
                <h4>Ticket Priority Report</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Priority</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(priorityCounts).map(([priority, count]) => `
                            <tr>
                                <td>${priority}</td>
                                <td>${count}</td>
                                <td>${((count / tickets.length) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Generate staff report
        function generateStaffReport(tickets) {
            const staffCounts = {};
            tickets.forEach(ticket => {
                const staff = ticket.assignedToName || 'Unassigned';
                staffCounts[staff] = (staffCounts[staff] || 0) + 1;
            });

            return `
                <h4>Staff Assignment Report</h4>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Assigned Tickets</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(staffCounts).map(([staff, count]) => `
                            <tr>
                                <td>${staff}</td>
                                <td>${count}</td>
                                <td>${((count / tickets.length) * 100).toFixed(1)}%</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Generate timeline report
        function generateTimelineReport(tickets) {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            const lastMonth = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

            const recentTickets = tickets.filter(ticket => {
                const ticketDate = new Date(ticket.createdAt);
                return ticketDate >= lastMonth;
            });

            const weeklyCounts = {};
            const monthlyCounts = {};

            recentTickets.forEach(ticket => {
                const ticketDate = new Date(ticket.createdAt);
                const weekKey = `Week ${Math.ceil((today - ticketDate) / (7 * 24 * 60 * 60 * 1000))}`;
                const monthKey = ticketDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });

                weeklyCounts[weekKey] = (weeklyCounts[weekKey] || 0) + 1;
                monthlyCounts[monthKey] = (monthlyCounts[monthKey] || 0) + 1;
            });

            return `
                <h4>Timeline Analysis Report</h4>
                <div class="timeline-report">
                    <div class="timeline-section">
                        <h5>Weekly Distribution (Last 4 Weeks)</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>New Tickets</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(weeklyCounts).map(([week, count]) => `
                                    <tr>
                                        <td>${week}</td>
                                        <td>${count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="timeline-section">
                        <h5>Monthly Distribution (Last 3 Months)</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>New Tickets</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(monthlyCounts).map(([month, count]) => `
                                    <tr>
                                        <td>${month}</td>
                                        <td>${count}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function logout() {
            sessionStorage.removeItem('managerLoggedIn');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
