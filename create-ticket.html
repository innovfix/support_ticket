<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Ticket - Query Desk</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-header-bar">
        <div class="header-left">
            <div class="app-icon-small">
                <i class="fas fa-users"></i>
            </div>
            <span class="app-name">Query Desk - Staff</span>
        </div>
        <div class="header-right">
            <a href="staff-dashboard.html" class="action-btn">‚Üê Back to Staff Dashboard</a>
            <button onclick="logout()" class="action-btn logout-btn">Logout</button>
        </div>
    </div>

                <div class="dashboard-container" style="max-width: 900px; margin: 20px auto;">
        
        <div class="create-ticket-section" style="background: rgba(25, 25, 25, 0.7); border-radius: 16px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.08);">
            <form id="createTicketForm" onsubmit="submitTicket(event)" class="create-ticket-form">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="mobileOrUserId" style="display: block; margin-bottom: 6px; color: #fff; font-weight: 500;">Mobile/User ID</label>
                        <input type="text" id="mobileOrUserId" name="mobileOrUserId" placeholder="10-digit mobile or User ID" required 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label for="issueType" style="display: block; margin-bottom: 6px; color: #fff; font-weight: 500;">Issue Type</label>
                        <select id="issueType" name="issueType" required 
                                style="width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 14px;">
                            <option value="">Select Issue Type</option>
                        </select>
                        <small style="display: block; color: #aaa; margin-top: 4px; font-size: 0.85rem;">Managed by Manager</small>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="issueDescription" style="display: block; margin-bottom: 6px; color: #fff; font-weight: 500;">Issue Description</label>
                    <textarea id="issueDescription" name="issueDescription" placeholder="Describe the issue in detail..." rows="2" required 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 14px; resize: vertical;"></textarea>
                </div>

                <div class="form-group" style="margin-bottom: 15px;">
                    <label for="screenshot" style="display: block; margin-bottom: 6px; color: #fff; font-weight: 500;">Screenshot (Optional)</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button type="button" class="screenshot-btn" onclick="document.getElementById('screenshot').click()" 
                                style="background: rgba(59, 130, 246, 0.8); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; min-width: 140px; justify-content: center; align-self: flex-start;">
                            <i class="fas fa-camera"></i> Choose Screenshot
                        </button>
                        <span style="color: #aaa; font-size: 0.75rem;">Upload an image to help describe the issue</span>
                    </div>
                    <input type="file" id="screenshot" name="screenshot" accept="image/*" style="display: none;">
                    <div id="screenshotPreview" style="margin-top: 10px; display: none; padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img id="previewImage" style="max-width: 80px; max-height: 80px; border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.2); object-fit: cover;">
                            <div>
                                <p style="margin: 0 0 4px 0; color: #fff; font-size: 0.85rem;">Screenshot uploaded successfully</p>
                                <button type="button" onclick="removeScreenshot()" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 500;">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions" style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 10px;">
                    <button type="button" onclick="window.location.href='staff-dashboard.html'" 
                            style="background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; min-width: 140px; justify-content: center;">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn" 
                            style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; min-width: 140px; justify-content: center;">
                        <i class="fas fa-plus"></i> Create Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="margin: 0; color: #10b981;"><i class="fas fa-check-circle"></i> Success!</h3>
                <span class="close" onclick="closeSuccessModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p style="margin: 0 0 15px 0; color: #333;">Ticket created successfully!</p>
                <p style="margin: 0; color: #666;">Ticket Code: <strong id="ticketCodeDisplay" style="color: #10b981; font-size: 1.1rem;"></strong></p>
            </div>
            <div class="form-actions" style="justify-content: center;">
                <button onclick="closeSuccessModal()" class="action-btn" style="background: #10b981;">Okay</button>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="margin: 0; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Error</h3>
                <span class="close" onclick="closeErrorModal()">&times;</span>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <p id="errorMessage" style="margin: 0; color: #333;"></p>
            </div>
            <div class="form-actions" style="justify-content: center;">
                <button onclick="closeErrorModal()" class="action-btn" style="background: #ef4444;">OK</button>
            </div>
        </div>
    </div>

    <script src="script.js?v=1.3"></script>
    <script>

        
        // Check if user is logged in as staff
        if (!sessionStorage.getItem('staffLoggedIn')) {
            window.location.href = 'staff-login.html';
        }

        // Load issue types when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadIssueTypesIntoStaff();
        });

        // Load issue types into dropdown
        async function loadIssueTypesIntoStaff() {
            try {
                console.log('Loading issue types...');
                const response = await fetch('api/issue-types-list.php');
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Issue types data:', data);
                    
                    if (data.types && data.types.length > 0) {
                        const issueTypeSelect = document.getElementById('issueType');
                        if (issueTypeSelect) {
                            issueTypeSelect.innerHTML = '<option value="">Select Issue Type</option>';
                            data.types.forEach(type => {
                                const option = document.createElement('option');
                                option.value = type.name;
                                option.textContent = type.name;
                                issueTypeSelect.appendChild(option);
                            });
                            console.log('Loaded', data.types.length, 'issue types');
                        }
                    } else {
                        console.log('No issue types from API, using fallback');
                        loadFallbackIssueTypes();
                    }
                } else {
                    console.log('API response not OK, using fallback');
                    loadFallbackIssueTypes();
                }
            } catch (error) {
                console.error('Error loading issue types:', error);
                console.log('Using fallback issue types');
                loadFallbackIssueTypes();
            }
        }

        // Load fallback issue types if API fails
        function loadFallbackIssueTypes() {
            const issueTypeSelect = document.getElementById('issueType');
            if (issueTypeSelect) {
                issueTypeSelect.innerHTML = '<option value="">Select Issue Type</option>';
                const fallbackTypes = [
                    'Withdrawal paid status not amount came',
                    'Coins not added',
                    'Call amount not added',
                    'App issue / crash',
                    'Bank details issue',
                    'KYC details related',
                    'Blocking user'
                ];
                
                fallbackTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    issueTypeSelect.appendChild(option);
                });
                console.log('Loaded', fallbackTypes.length, 'fallback issue types');
            }
        }



        // Handle screenshot preview
        document.getElementById('screenshot').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('screenshotPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function removeScreenshot() {
            document.getElementById('screenshot').value = '';
            document.getElementById('screenshotPreview').style.display = 'none';
        }

        // Submit ticket form
        async function submitTicket(event) {
            event.preventDefault();
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            submitBtn.disabled = true;
            
            // Get current staff member ID
            const currentStaffId = sessionStorage.getItem('currentStaffId') || localStorage.getItem('currentStaffId');

            
            const formData = new FormData();
            formData.append('mobileOrUserId', document.getElementById('mobileOrUserId').value);
            formData.append('issueType', document.getElementById('issueType').value);
            formData.append('issueDescription', document.getElementById('issueDescription').value);
            formData.append('createdBy', currentStaffId || 'Staff');
            
            const screenshotFile = document.getElementById('screenshot').files[0];
            if (screenshotFile) {
                formData.append('screenshot', screenshotFile);
            }

            try {
                const response = await fetch('api/tickets-create.php', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('ticketCodeDisplay').textContent = result.ticketCode;
                        document.getElementById('successModal').style.display = 'block';
                    } else {
                        showError(result.message || 'Failed to create ticket');
                    }
                } else {
                    showError('Failed to create ticket. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Network error. Please check your connection.');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'block';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
            // Reset form and hide screenshot preview
            document.getElementById('createTicketForm').reset();
            document.getElementById('screenshotPreview').style.display = 'none';
        }

        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }

        function logout() {
            sessionStorage.removeItem('staffLoggedIn');
            window.location.href = 'index.html';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
